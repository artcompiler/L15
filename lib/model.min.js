var assert=function(){return DEBUG?function(b,e){void 0===e&&(e="failed!");if(!b)try{throw Error(e);}catch(l){throw l.message+"\n"+l.stack;}}:function(){}}(),message=function(b,e){var l=Assert.messages[b];e&&e.forEach(function(b,d){l=l.replace("%"+(d+1),b)});return b+": "+l},Assert={assert:assert,message:message,messages:{}};var global=this,trace=function(){return DEBUG?function(b){if(global.console&&global.console.log)console.log(b);else if(global.print)print(b);else throw"No trace function defined!";}:function(){}}();var Ast=function(){function b(){}function e(b){void 0===b&&(b=this);return b.op&&b.args}var l=["unused"],a={};b.clearPool=function(){l=["unused"];a={}};b.prototype.create=function(b,a){var c=Object.create(this);"string"===typeof b?(c.op=b,c.args=a instanceof Array?a:[]):null!==b&&"object"===typeof b&&Object.keys(b).forEach(function(a,n){c[a]=b[a]});return c};b.prototype.arg=function(b){if(!e(this))throw"Malformed node";this.args.push(b);return this};b.prototype.argN=function(b,a){if(!e(this))throw"Malformed node";
if(void 0===a)return this.args[b];this.args[b]=a;return this};b.prototype.args=function(b){if(!e(this))throw"Malformed node";if(void 0===b)return this.args;this.args=b;return this};b.prototype.isNode=e;b.intern=b.prototype.intern=function s(c){this instanceof b&&void 0===c&&e(this)&&(c=this);"number"===typeof c?c={op:"num",args:[c]}:"string"===typeof c&&(c={op:"str",args:[c]});assert("object"===typeof c,"node not an object");for(var p=c.op,n=c.args.length,q="",g=[],f=0;f<n;f++)q="num"===c.op||"str"===
c.op?q+(g[f]=c.args[f]):q+(g[f]=s(c.args[f]));c=p+n+q;n=a[c];void 0===n&&(l.push({op:p,args:g}),n=l.length-1,a[c]=n);return n};b.prototype.node=function(b){b=JSON.parse(JSON.stringify(l[b]));var a=this.create(b);switch(b.op){case "num":case "str":b=b.args[0];break;default:for(var p=0;p<b.args.length;p++)b.args[p]=a(b.args[p])}return b};b.dumpAll=b.prototype.dumpAll=function(){var a="";l.forEach(function(c,p){a+="\n"+p+": "+b.dump(c)});return a};b.dump=b.prototype.dump=function c(b){if("string"===
typeof b)var a='"'+b+'"';else if("number"===typeof b)a=b;else{for(var a='{ op: "'+b.op+'", args: [ ',q=0;q<b.args.length;q++)0<q&&(a+=" , "),a+=c(b.args[q]);a+=" ] }"}return a};return b}();var Model=function(){function b(){}b.fn={};var e=b.prototype=new Ast;Assert.messages[1001]="Invalid syntax. '%1' expected, '%2' found.";var l=Assert.message;b.create=e.create=function(a){assert(a,"Model.create() called with invalid argument: "+a);if(a instanceof b)return a;if(!(this instanceof b))return(new b).create(a);var d=Object.create(this);a="string"===typeof a?c(a).expr():JSON.parse(JSON.stringify(a));Object.keys(b.fn).forEach(function(a,g){e.hasOwnProperty(a)||(e[a]=function(){var f=b.fn[a];
if(1<arguments.length&&arguments[1]instanceof b)return f.apply(this,arguments);for(var g=[this],d=0;d<arguments.length;d++)g.push(arguments[d]);return f.apply(this,g)})});Object.keys(a).forEach(function(b,g){d[b]=a[b]});return d};b.fromLaTex=e.fromLaTex=function(a){assert("string"===typeof a,"Model.prototype.fromLaTex");return this?this.create(a):b.create(a)};e.toLaTex=function(b){return s(b)};var a={ADD:"+",SUB:"-",MUL:"times",DIV:"div",FRAC:"frac",EQL:"=",ATAN2:"atan2",SQRT:"sqrt",PM:"pm",SIN:"sin",
COS:"cos",TAN:"tan",SEC:"sec",COT:"cot",CSC:"csc",LN:"ln",VAR:"var",NUM:"num",CST:"cst",COMMA:",",POW:"^",ABS:"abs",PAREN:"()",HIGHLIGHT:"hi",INTERVAL:"interval"};Object.keys(a).forEach(function(d,c){b[d]=a[d]});var d={};d[a.ADD]="+";d[a.SUB]="-";d[a.MUL]="\\times";d[a.DIV]="\\div";d[a.FRAC]="\\frac";d[a.EQL]="=";d[a.ATAN2]="\\atan2";d[a.POW]="^";d[a.PM]="\\pm";d[a.SIN]="\\sin";d[a.COS]="\\cos";d[a.TAN]="\\tan";d[a.SEC]="\\sec";d[a.COT]="\\cot";d[a.CSC]="\\csc";d[a.LN]="\\ln";d[a.COMMA]=",";var s=
function n(b){var g="";if("string"===typeof b)g=b;else if("number"===typeof b)g=b;else if("object"===typeof b){for(var f=[],c=0;c<b.args.length;c++)f[c]=n(b.args[c]);switch(b.op){case a.VAR:case a.CST:case a.NUM:g=b.args[0];break;case a.SUB:g=1===b.args.length?d[b.op]+" "+f[0]:f[0]+" "+d[b.op]+" "+f[1];break;case a.DIV:case a.PM:case a.EQL:g=f[0]+" "+d[b.op]+" "+f[1];break;case a.POW:var c=b.args[0],e=b.args[1];if(c.args&&2===c.args.length||e.args&&2===e.args.length)if(c.op===a.ADD||c.op===a.SUB||
c.op===a.MUL||c.op===a.DIV||c.op===a.SQRT)f[0]=" ("+f[0]+") ";g="{"+f[0]+"^{"+f[1]+"}}";break;case a.SIN:case a.COS:case a.TAN:case a.SEC:case a.COT:case a.CSC:case a.LN:g="{"+d[b.op]+"{"+f[0]+"}}";break;case a.FRAC:g="\\dfrac{"+f[0]+"}{"+f[1]+"}";break;case a.SQRT:switch(f.length){case 1:g="\\sqrt{"+f[0]+"}";break;case 2:g="\\sqrt["+f[0]+"]{"+f[1]+"}"}break;case a.MUL:var l,g="";b.args.forEach(function(c,e){if(c.args&&2<=c.args.length){if(c.op===a.ADD||c.op===a.SUB)f[e]="("+f[e]+")";0!==e&&"number"===
typeof c&&(g+=d[b.op]+" ")}else c.op===a.PAREN||c.op===a.VAR||c.op===a.CST||"number"===typeof l&&"number"!==typeof c||0!==e&&(g+=" "+d[b.op]+" ");g+=f[e];l=c});break;case a.ADD:case a.COMMA:f.forEach(function(a,c){g=0===c?a:g+" "+d[b.op]+" "+a});break;default:assert(!1,"unimplemented eval operator")}}else assert(!1,"invalid expression type");return g},c=function(a){function c(){m=R;R=w;m===w&&(m=r.start())}function d(b){var a=m;a!==b&&(b=String.fromCharCode(b),a=a?String.fromCharCode(a):"EOS",assert(!1,
l(1001,[b,a])));c()}function f(){d(A);var b=x();d(Y);return b}function e(){var a;switch(m){case B:c();a=e();break;case y:c();a=e();a={op:b.SUB,args:[a]};break;default:var h;switch(a=m){case 65:case u:h={op:"var",args:[r.lexeme()]};c();break;case 97:h={op:"var",args:[r.lexeme()]};c();break;case S:h={op:"num",args:[r.lexeme()]};c();break;case T:d(a);h=x();d(tk2=m===U?U:C);2===h.args.length||a!==D&&tk2!==C||assert(!1,"Square brackets can only be used to denote intervals.");h.lbrk=a;h.rbrk=tk2;break;
case A:h=f();break;case t:c();a=f();h=f();h={op:b.MUL,args:[a,{op:b.POW,args:[h,{op:b.NUM,args:["-1"]}]}]};break;case E:c();switch(m){case D:d(D);a=x();d(C);h=f();h={op:b.POW,args:[h,a,{op:b.NUM,args:["-1"]}]};break;case A:h=f();h=h.op===b.POW?{op:b.POW,args:[h.args[0],{op:b.MUL,args:[h.args[1],{op:b.POW,args:[{op:b.NUM,args:["2"]},{op:b.NUM,args:["-1"]}]}]}]}:{op:b.POW,args:[h,{op:b.NUM,args:["2"]},{op:b.NUM,args:["-1"]}]};break;default:assert(!1)}break;case F:case G:case H:case I:case J:case K:case L:c();
h={op:k[a],args:[f()]};break;default:h=void 0}a=h}return a}function s(){for(var a=[e()];m===V;)c(),a.push(e());return 1<a.length?{op:b.POW,args:a}:a[0]}function O(){for(var a,d,f=[s()];(a=m)===u||a===T||a===z||a===v||a===t;)a===z||a===v||a===t?(op=k[a],c()):op=b.MUL,d=s(),a===v&&(d={op:b.POW,args:[d,{op:b.NUM,args:["-1"]}]}),f.push(d);return 1<f.length?{op:b.MUL,args:f}:f[0]}function P(a){if("number"===typeof a)return-a;if(1===a.args.length){if(a.op===b.SUB)return a.args[0];if(a.op===b.ADD)return a.args[0]=
P(a.args[0]),a;if(a.op===b.NUM||a.op===b.VAR)return{op:b.MUL,args:[{op:b.NUM,args:["-1"]},a]}}else if(2===a.args.length)return{op:b.SUB,args:[a]};assert(!1,"negate() op="+a.op+" n.args.length="+a.args.length);return{op:b.SUB,args:[a]}}function Q(){function a(b){return b===B||b===y||b===M}for(var d=O(),f;a(f=m);){c();var e=O();switch(f){case y:e=P(e);default:d={op:b.ADD,args:[d,e]}}}return d}function W(){for(var a=Q(),b;(b=m)===X;){c();var d=Q(),a={op:k[b],args:[a,d]}}return a}function x(){for(var a=
W(),b=[a];m===N;)c(),b.push(W());return 1<b.length?{op:k[N],args:b}:a}var w=0,B=43,V=94,G=261,J=264,K=265,v=47,X=61,t=256,L=263,A=123,D=91,T=40,z=42,S=48,M=258,Y=125,C=93,U=41,I=262,F=259,E=257,y=45,H=260,u=97,N=44,k=[],m=w,R=w;k[t]="frac";k[E]="sqrt";k[B]="+";k[y]="-";k[M]="pm";k[V]="^";k[z]="times";k[v]="frac";k[F]="sin";k[G]="cos";k[H]="tan";k[I]="sec";k[J]="cot";k[K]="csc";k[L]="ln";k[X]="=";k[N]=",";var r=function(a){function b(f){var g=String.fromCharCode(f);for(d+=g;97<=f&&122>=f;){f=a.charCodeAt(c++);
var g=String.fromCharCode(f),h=d+g;if(!e.some(function(a){return 0===a.indexOf(h)}))break;d+=g}c--;return u}var c=0,d="",f=[];f["\\times"]=z;f["\\div"]=v;f["\\dfrac"]=t;f["\\frac"]=t;f["\\sqrt"]=E;f["\\pm"]=M;f["\\sin"]=F;f["\\cos"]=G;f["\\tan"]=H;f["\\sec"]=I;f["\\cot"]=J;f["\\csc"]=K;f["\\ln"]=L;var e="g cg kg mg ng m cm km mm nm s cs ks ms ns in ft mi fl gi pt qt gal oz lb st qtr cwt t".split(" ");return{start:function(){var e;for(d="";c<a.length;)switch(e=a.charCodeAt(c++)){case 32:case 9:case 10:case 13:continue;
case 92:d+=String.fromCharCode(e);for(e=a.charCodeAt(c++);97<=e&&122>=e;)d+=String.fromCharCode(e),e=a.charCodeAt(c++);c--;e=f[d];void 0===e&&(e=u);return e;case 40:case 41:case 42:case 43:case 44:case 45:case 47:case 61:case 91:case 93:case 94:case 123:case 125:return d+=String.fromCharCode(e),e;default:if(65<=e&&90>=e)return d+=String.fromCharCode(e),u;if(97<=e&&122>=e)return b(e);if(46===e||48<=e&&57>=e){for(;48<=e&&57>=e||46===e;)d+=String.fromCharCode(e),e=a.charCodeAt(c++);c--;return S}assert(!1,
"scan.start(): c="+e);return 0}return 0},lexeme:function(){return d},pos:function(){return c}}}(a);return{expr:function(){m=r.start();var a=x();assert(!m,"Unexpected input at character position: "+r.pos()+" lexeme: "+r.lexeme());return a}}};return b}();
