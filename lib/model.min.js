var assert=function(){return DEBUG?function(){}:function(b,h){void 0===h&&(h="failed!");if(!b)try{throw Error("assert: "+h);}catch(a){throw a+"\n"+a.stack;}}}();var global=this,trace=function(){return DEBUG?function(b){if(global.console&&global.console.log)console.log(b);else if(global.print)print(b);else throw"No trace function defined!";}:function(){}}();var Ast=function(){function b(){}function h(a){void 0===a&&(a=this);return a.op&&a.args}var a=["unused"],c={};b.clearPool=function(){a=["unused"];c={}};b.prototype.create=function(a,b){var g=Object.create(this);"string"===typeof a?(g.op=a,g.args=b instanceof Array?b:[]):null!==a&&"object"===typeof a&&Object.keys(a).forEach(function(b,n){g[b]=a[b]});return g};b.prototype.arg=function(a){if(!h(this))throw"Malformed node";this.args.push(a);return this};b.prototype.argN=function(a,b){if(!h(this))throw"Malformed node";
if(void 0===b)return this.args[a];this.args[a]=b;return this};b.prototype.args=function(a){if(!h(this))throw"Malformed node";if(void 0===a)return this.args;this.args=a;return this};b.prototype.isNode=h;b.intern=b.prototype.intern=function p(g){this instanceof b&&void 0===g&&h(this)&&(g=this);"number"===typeof g?g={op:"num",args:[g]}:"string"===typeof g&&(g={op:"str",args:[g]});assert("object"===typeof g,"node not an object");for(var q=g.op,n=g.args.length,e="",f=[],d=0;d<n;d++)e="num"===g.op||"str"===
g.op?e+(f[d]=g.args[d]):e+(f[d]=p(g.args[d]));g=q+n+e;n=c[g];void 0===n&&(a.push({op:q,args:f}),n=a.length-1,c[g]=n);return n};b.prototype.node=function(b){b=JSON.parse(JSON.stringify(a[b]));var g=this.create(b);switch(b.op){case "num":case "str":b=b.args[0];break;default:for(var c=0;c<b.args.length;c++)b.args[c]=g(b.args[c])}return b};b.dumpAll=b.prototype.dumpAll=function(){var c="";a.forEach(function(a,q){c+="\n"+q+": "+b.dump(a)});return c};b.dump=b.prototype.dump=function g(a){if("string"===
typeof a)var b='"'+a+'"';else if("number"===typeof a)b=a;else{for(var b='{ op: "'+a.op+'", args: [ ',e=0;e<a.args.length;e++)0<e&&(b+=" , "),b+=g(a.args[e]);b+=" ] }"}return b};return b}();var Model=function(){function b(){}b.fn={};var h=b.prototype=new Ast;b.create=h.create=function(a){assert(a,"Model.create() called with invalid argument: "+a);if(!(this instanceof b))return(new b).create(a);var c=Object.create(this);a="string"===typeof a?p(a).expr():JSON.parse(JSON.stringify(a));Object.keys(b.fn).forEach(function(a,c){h.hasOwnProperty(a)||(h[a]=function(){var c=b.fn[a];if(1<arguments.length&&arguments[1]instanceof b)return c.apply(this,arguments);for(var e=[this],g=0;g<arguments.length;g++)e.push(arguments[g]);
return c.apply(this,e)})});Object.keys(a).forEach(function(b,e){c[b]=a[b]});return c};b.fromLaTex=h.fromLaTex=function(a){assert("string"===typeof a,"Model.prototype.fromLaTex");return this?this.create(a):b.create(a)};h.toLaTex=function(a){return B(a)};var a={ADD:"+",SUB:"-",MUL:"times",DIV:"div",FRAC:"frac",EQL:"=",ATAN2:"atan2",SQRT:"sqrt",PM:"pm",SIN:"sin",COS:"cos",TAN:"tan",SEC:"sec",COT:"cot",CSC:"csc",LN:"ln",VAR:"var",NUM:"num",CST:"cst",COMMA:",",POW:"^",ABS:"abs",PAREN:"()",HIGHLIGHT:"hi"};
Object.keys(a).forEach(function(c,h){b[c]=a[c]});var c={};c[a.ADD]="+";c[a.SUB]="-";c[a.MUL]="\\times";c[a.DIV]="\\div";c[a.FRAC]="\\frac";c[a.EQL]="=";c[a.ATAN2]="\\atan2";c[a.POW]="^";c[a.PM]="\\pm";c[a.SIN]="\\sin";c[a.COS]="\\cos";c[a.TAN]="\\tan";c[a.SEC]="\\sec";c[a.COT]="\\cot";c[a.CSC]="\\csc";c[a.LN]="\\ln";c[a.COMMA]=",";var B=function q(b){var e="";if("string"===typeof b)e=b;else if("number"===typeof b)e=b;else if("object"===typeof b){for(var f=[],d=0;d<b.args.length;d++)f[d]=q(b.args[d]);
switch(b.op){case a.VAR:case a.CST:case a.NUM:e=b.args[0];break;case a.SUB:e=1===b.args.length?c[b.op]+" "+f[0]:f[0]+" "+c[b.op]+" "+f[1];break;case a.DIV:case a.PM:case a.EQL:e=f[0]+" "+c[b.op]+" "+f[1];break;case a.POW:var d=b.args[0],h=b.args[1];if(d.args&&2===d.args.length||h.args&&2===h.args.length)if(d.op===a.ADD||d.op===a.SUB||d.op===a.MUL||d.op===a.DIV||d.op===a.SQRT)f[0]=" ("+f[0]+") ";e="{"+f[0]+"^{"+f[1]+"}}";break;case a.SIN:case a.COS:case a.TAN:case a.SEC:case a.COT:case a.CSC:case a.LN:e=
"{"+c[b.op]+"{"+f[0]+"}}";break;case a.FRAC:e="\\dfrac{"+f[0]+"}{"+f[1]+"}";break;case a.SQRT:switch(f.length){case 1:e="\\sqrt{"+f[0]+"}";break;case 2:e="\\sqrt["+f[0]+"]{"+f[1]+"}"}break;case a.MUL:var r,e="";b.args.forEach(function(d,h){if(d.args&&2<=d.args.length){if(d.op===a.ADD||d.op===a.SUB)f[h]="("+f[h]+")";0!==h&&"number"===typeof d&&(e+=c[b.op]+" ")}else d.op===a.PAREN||d.op===a.VAR||d.op===a.CST||"number"===typeof r&&"number"!==typeof d||0!==h&&(e+=" "+c[b.op]+" ");e+=f[h];r=d});break;
case a.ADD:case a.COMMA:f.forEach(function(a,d){e=0===d?a:e+" "+c[b.op]+" "+a});break;default:assert(!1,"unimplemented eval operator")}}else assert(!1,"invalid expression type");return e},p=function(a){function c(){m=P;P=w;m===w&&(m=s.start())}function e(a){var b=m;b!==a&&(assert(!1,"Expecting "+a+" found "+b),trace("error: syntax error"));c()}function f(){e(C);var a=y();e(B);return a}function d(){var a;switch(m){case D:c();a=d();break;case z:c();a=d();a={op:b.SUB,args:[a]};break;default:var x;switch(x=
m){case 65:case t:a={op:"var",args:[s.lexeme()]};c();break;case 97:a={op:"var",args:[s.lexeme()]};c();break;case Q:a={op:"num",args:[s.lexeme()]};c();break;case E:e(E);a=y();e(U);break;case C:a=f();break;case u:c();a={op:k[u],args:[f(),f()]};break;case v:c();switch(m){case R:a=k[v];e(R);x=y();e(V);a={op:a,args:[x,f()]};break;case C:a={op:k[v],args:[f()]};break;default:assert(!1)}break;case F:case G:case H:case I:case J:case K:case L:c();a={op:k[x],args:[f()]};break;default:a=void 0}}return a}function h(){for(var a=
d(),b;(b=m)===S;){c();var e=d();1!==e&&(a=0===e?1:{op:k[b],args:[a,e]})}return a}function r(){function a(b){return b===A||b===M}for(var b=h(),e;(e=m)===t||e===E;){var d=h();1!==d&&(b=1===b?d:{op:l.MUL,args:[b,d]})}for(;a(e=m);)c(),d=h(),1!==d&&(b=e===A&&1===b?d:{op:k[e],args:[b,d]});return b}function p(a){if("number"===typeof a)return-a;if(1===a.args.length){if(a.op===b.SUB)return a.args[0];if(a.op===b.ADD)return a.args[0]=p(a.args[0]),a;if(a.op===b.NUM||a.op===b.VAR)return{op:b.MUL,args:[{op:b.NUM,
args:["-1"]},a]}}else if(2===a.args.length)return{op:b.SUB,args:[a]};assert(!1,"negate() op="+a.op+" n.args.length="+a.args.length);return{op:b.SUB,args:[a]}}function O(){function a(b){return b===D||b===z||b===N}for(var e=r(),d;a(d=m);){c();var f=r();switch(d){case z:f=p(f);default:e={op:b.ADD,args:[e,f]}}}return e}function y(){for(var a=O(),b;(b=m)===T;){c();var e=O(),a={op:k[b],args:[a,e]}}return a}var w=0,D=43,S=94,G=261,J=264,K=265,M=47,T=61,u=256,L=263,C=123,R=91,E=40,A=42,Q=48,N=258,B=125,V=
93,U=41,I=262,F=259,v=257,z=45,H=260,t=97,l={ADD:"+",SUB:"-",MUL:"times",DIV:"div",FRAC:"frac",EQL:"=",ATAN2:"atan2",SQRT:"sqrt",PM:"pm",SIN:"sin",COS:"cos",TAN:"tan",SEC:"sec",COT:"cot",CSC:"csc",LN:"ln",VAR:"var",CST:"cst",COMMA:",",POW:"^",ABS:"abs",PAREN:"()",HIGHLIGHT:"hi"},k=[],m=w,P=w;k[u]=l.FRAC;k[v]=l.SQRT;k[D]=l.ADD;k[z]=l.SUB;k[N]=l.PM;k[S]=l.POW;k[A]=l.MUL;k[M]=l.FRAC;k[F]=l.SIN;k[G]=l.COS;k[H]=l.TAN;k[I]=l.SEC;k[J]=l.COT;k[K]=l.CSC;k[L]=l.LN;k[T]=l.EQL;var s=function(a){var b=0,c="",
e=[];e["\\times"]=A;e["\\div"]=M;e["\\dfrac"]=u;e["\\frac"]=u;e["\\sqrt"]=v;e["\\pm"]=N;e["\\sin"]=F;e["\\cos"]=G;e["\\tan"]=H;e["\\sec"]=I;e["\\cot"]=J;e["\\csc"]=K;e["\\ln"]=L;return{start:function(){var d;for(c="";b<a.length;)switch(d=a.charCodeAt(b++)){case 32:case 9:case 10:case 13:continue;case 92:c+=String.fromCharCode(d);for(d=a.charCodeAt(b++);97<=d&&122>=d;)c+=String.fromCharCode(d),d=a.charCodeAt(b++);b--;d=e[c];void 0===d&&(d=t);return d;case 40:case 41:case 42:case 43:case 44:case 45:case 47:case 61:case 91:case 93:case 94:case 123:case 125:return c+=
String.fromCharCode(d),d;default:if(65<=d&&90>=d||97<=d&&122>=d)return c+=String.fromCharCode(d),t;if(48<=d&&57>=d){for(;48<=d&&57>=d||46===d;)c+=String.fromCharCode(d),d=a.charCodeAt(b++);b--;return Q}assert(!1,"scan.start(): c="+d);return 0}return 0},lexeme:function(){return c}}}(a);return{expr:function(){m=s.start();return y()}}};return b}();
