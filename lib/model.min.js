var assert=function(){return DEBUG?function(){}:function(b,l){void 0===l&&(l="failed!");if(!b)try{throw Error("assert: "+l);}catch(n){throw n+"\n"+n.stack;}}}();var global=this,trace=function(){return DEBUG?function(b){if(global.console&&global.console.log)console.log(b);else if(global.print)print(b);else throw"No trace function defined!";}:function(){}}();var Ast=function(){function b(){}function l(b){void 0===b&&(b=this);return b.op&&b.args}function n(){trace("Ast self testing");var d=new b,e=d.create("+").arg(10).arg(30),f=d.create("+",[10,20]),a=d.create({op:"+",args:[10,20]}),c=d.intern({op:"+",args:[10,20]}),r=d.intern({op:"+",args:[10,30]});d.intern({op:"num",args:[10]});e=e.intern();f=f.intern();a=a.intern();trace((r===e?"PASS":"FAIL")+": nid2 === nid4");trace((c===f?"PASS":"FAIL")+": nid1 === nid5");trace((f===a?"PASS":"FAIL")+": nid5 === nid6");
trace(d.dumpAll())}var d=["unused"],e={};b.clearPool=function(){d=["unused"];e={}};b.prototype.create=function(b,d){var f=Object.create(this);"string"===typeof b?(f.op=b,f.args=d instanceof Array?d:[]):null!==b&&"object"===typeof b&&Object.keys(b).forEach(function(a,c){f[a]=b[a]});return f};b.prototype.arg=function(b){if(!l(this))throw"Malformed node";this.args.push(b);return this};b.prototype.argN=function(b,d){if(!l(this))throw"Malformed node";if(void 0===d)return this.args[b];this.args[b]=d;return this};
b.prototype.args=function(b){if(!l(this))throw"Malformed node";if(void 0===b)return this.args;this.args=b;return this};b.prototype.isNode=l;b.intern=b.prototype.intern=function q(f){this instanceof b&&void 0===f&&l(this)&&(f=this);"number"===typeof f?f={op:"num",args:[f]}:"string"===typeof f&&(f={op:"str",args:[f]});assert("object"===typeof f,"node not an object");for(var a=f.op,c=f.args.length,r="",h=[],g=0;g<c;g++)r="num"===f.op||"str"===f.op?r+(h[g]=f.args[g]):r+(h[g]=q(f.args[g]));f=a+c+r;c=e[f];
void 0===c&&(d.push({op:a,args:h}),c=d.length-1,e[f]=c);return c};b.prototype.node=function(b){b=JSON.parse(JSON.stringify(d[b]));var f=this.create(b);switch(b.op){case "num":case "str":b=b.args[0];break;default:for(var a=0;a<b.args.length;a++)b.args[a]=f(b.args[a])}return b};b.dumpAll=b.prototype.dumpAll=function(){var e="";d.forEach(function(f,a){e+="\n"+a+": "+b.dump(f)});return e};b.dump=b.prototype.dump=function f(b){if("string"===typeof b)var c='"'+b+'"';else if("number"===typeof b)c=b;else{for(var c=
'{ op: "'+b.op+'", args: [ ',d=0;d<b.args.length;d++)0<d&&(c+=" , "),c+=f(b.args[d]);c+=" ] }"}return c};TEST&&n();return b}();var Model=function(){function b(){}function l(){trace("\nModel self testing");var f=new b,a=f.fromLaTex("10 + 20");a.intern();var c=f.toLaTex(a);trace(("10 + 20"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c);c=b.create("10 + 20").intern();a.intern();a=b.create({op:"+",args:[{op:"num",args:[10]},{op:"num",args:[20]}]}).intern();trace((c===a?"PASS":"FAIL")+": Model.create() nid1="+c+" nid2="+a);a=b.create("e^2");a.intern();c=f.toLaTex(a);trace(("{e^{2}}"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+
c);a=b.create("(x+2)(x-3)");a.intern();c=f.toLaTex(a);trace(("(x + 2)(x - 3)"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c);a=b.create("x^2+2x-1");a.intern();c=f.toLaTex(a);trace(("{x^{2}} + 2x - 1"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c);a=b.create("e^(2pi)");a.intern();c=f.toLaTex(a);trace(("{e^{2pi}}"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c);a=b.create("sin(2x)");a.intern();c=f.toLaTex(a);trace(("{e^{2pi}}"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c);a=b.create("2sin(x)cos(x)");
a.intern();c=f.toLaTex(a);trace(("{e^{2pi}}"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c);a=b.create("(x+y)^2");a.intern();c=f.toLaTex(a);trace(("{ (x + y) ^{2}}"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c);a=b.create("x^2+2xy+y^2");a.intern();c=f.toLaTex(a);trace(("{x^{2}} + 2xy + {y^{2}}"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c);a=b.create("x=2(y+1)");a.intern();c=f.toLaTex(a);trace(("x = 2(y + 1)"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c);a=b.create("x=2*y+2");a.intern();c=f.toLaTex(a);
trace(("x = 2y + 2"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c);a=b.create("x-2=2*y");a.intern();c=f.toLaTex(a);trace(("x - 2 = 2y"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c);a=b.create("0.00012");c=f.toLaTex(a);trace(("0.00012"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c);a=b.create("1.2e-4");c=f.toLaTex(a);trace(("1.2e - 4"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c);a=b.create("3m2cm");a.intern();c=f.toLaTex(a);trace((""===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c);a=b.create("302cm");
a.intern();c=f.toLaTex(a);trace(("302cm"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c);a=b.create("45N*m");c=f.toLaTex(a);trace((""===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c+" expected: 45Nm");a=b.create("45J");c=f.toLaTex(a);trace((""===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c+" expected: 45J");a=b.create("((x)*(y))");a.intern();c=f.toLaTex(a);trace(("xy"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c);a=b.create("1/2");a.intern();c=f.toLaTex(a);trace(("\\dfrac{1}{2}"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+
c);a=b.create("a+b+c+d+e+f");a.intern();c=f.toLaTex(a);trace(("a + b + c + d + e + f"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c);a=b.create("f(n+1)");a.intern();c=f.toLaTex(a);trace(("f(n + 1)"===c?"PASS":"FAIL")+": fromLaTex, toLaTex: "+c)}b.fn={};var n=b.prototype=new Ast;b.create=n.create=function(f){assert(f,"Model.create() called with invalid argument: "+f);if(!(this instanceof b))return(new b).create(f);var a=Object.create(this);f="string"===typeof f?q(f).expr():JSON.parse(JSON.stringify(f));
Object.keys(b.fn).forEach(function(c,a){n.hasOwnProperty(c)||(n[c]=function(){var a=b.fn[c];if(1<arguments.length&&arguments[1]instanceof b)return a.apply(this,arguments);for(var f=[this],d=0;d<arguments.length;d++)f.push(arguments[d]);return a.apply(this,f)})});Object.keys(f).forEach(function(c,b){a[c]=f[c]});return a};b.fromLaTex=n.fromLaTex=function(f){assert("string"===typeof f,"Model.prototype.fromLaTex");return this?this.create(f):b.create(f)};n.toLaTex=function(b){return B(b)};var d={ADD:"+",
SUB:"-",MUL:"times",DIV:"div",FRAC:"frac",EQL:"=",ATAN2:"atan2",SQRT:"sqrt",PM:"pm",SIN:"sin",COS:"cos",TAN:"tan",SEC:"sec",COT:"cot",CSC:"csc",LN:"ln",VAR:"var",NUM:"num",CST:"cst",COMMA:",",POW:"^",ABS:"abs",PAREN:"()",HIGHLIGHT:"hi"};Object.keys(d).forEach(function(f,a){b[f]=d[f]});var e={};e[d.ADD]="+";e[d.SUB]="-";e[d.MUL]="\\times";e[d.DIV]="\\div";e[d.FRAC]="\\frac";e[d.EQL]="=";e[d.ATAN2]="\\atan2";e[d.POW]="^";e[d.PM]="\\pm";e[d.SIN]="\\sin";e[d.COS]="\\cos";e[d.TAN]="\\tan";e[d.SEC]="\\sec";
e[d.COT]="\\cot";e[d.CSC]="\\csc";e[d.LN]="\\ln";e[d.COMMA]=",";var B=function a(c){var b="";if("string"===typeof c)b=c;else if("number"===typeof c)b=c;else if("object"===typeof c){for(var h=[],g=0;g<c.args.length;g++)h[g]=a(c.args[g]);switch(c.op){case d.VAR:case d.CST:case d.NUM:b=c.args[0];break;case d.SUB:b=1===c.args.length?e[c.op]+" "+h[0]:h[0]+" "+e[c.op]+" "+h[1];break;case d.DIV:case d.PM:case d.EQL:b=h[0]+" "+e[c.op]+" "+h[1];break;case d.POW:var g=c.args[0],l=c.args[1];if(g.args&&2===g.args.length||
l.args&&2===l.args.length)if(g.op===d.ADD||g.op===d.SUB||g.op===d.MUL||g.op===d.DIV||g.op===d.SQRT)h[0]=" ("+h[0]+") ";b="{"+h[0]+"^{"+h[1]+"}}";break;case d.SIN:case d.COS:case d.TAN:case d.SEC:case d.COT:case d.CSC:case d.LN:b="{"+e[c.op]+"{"+h[0]+"}}";break;case d.FRAC:b="\\dfrac{"+h[0]+"}{"+h[1]+"}";break;case d.SQRT:switch(h.length){case 1:b="\\sqrt{"+h[0]+"}";break;case 2:b="\\sqrt["+h[0]+"]{"+h[1]+"}"}break;case d.MUL:var n,b="";c.args.forEach(function(a,g){if(a.args&&2<=a.args.length){if(a.op===
d.ADD||a.op===d.SUB)h[g]="("+h[g]+")";0!==g&&"number"===typeof a&&(b+=e[c.op]+" ")}else a.op===d.PAREN||a.op===d.VAR||a.op===d.CST||"number"===typeof n&&"number"!==typeof a||0!==g&&(b+=" "+e[c.op]+" ");b+=h[g];n=a});break;case d.ADD:case d.COMMA:h.forEach(function(a,d){b=0===d?a:b+" "+e[c.op]+" "+a});break;default:assert(!1,"unimplemented eval operator")}}else assert(!1,"invalid expression type");return b},q=function(a){function c(){p=P;P=w;p===w&&(p=s.start())}function d(b){var a=p;a!==b&&(assert(!1,
"Expecting "+b+" found "+a),trace("error: syntax error"));c()}function e(){d(C);var b=y();d(B);return b}function g(){var a;switch(p){case D:c();a=g();break;case z:c();a=g();a={op:b.SUB,args:[a]};break;default:var x;switch(x=p){case 65:case t:a={op:"var",args:[s.lexeme()]};c();break;case 97:a={op:"var",args:[s.lexeme()]};c();break;case Q:a={op:"num",args:[s.lexeme()]};c();break;case E:d(E);a=y();d(U);break;case C:a=e();break;case u:c();a={op:k[u],args:[e(),e()]};break;case v:c();switch(p){case R:a=
k[v];d(R);x=y();d(V);a={op:a,args:[x,e()]};break;case C:a={op:k[v],args:[e()]};break;default:assert(!1)}break;case F:case G:case H:case I:case J:case K:case L:c();a={op:k[x],args:[e()]};break;default:a=void 0}}return a}function l(){for(var b=g(),a;(a=p)===S;){c();var d=g();1!==d&&(b=0===d?1:{op:k[a],args:[b,d]})}return b}function n(){function b(a){return a===A||a===M}for(var a=l(),d;(d=p)===t||d===E;){var e=l();1!==e&&(a=1===a?e:{op:m.MUL,args:[a,e]})}for(;b(d=p);)c(),e=l(),1!==e&&(a=d===A&&1===a?
e:{op:k[d],args:[a,e]});return a}function q(a){if("number"===typeof a)return-a;if(1===a.args.length){if(a.op===b.SUB)return a.args[0];if(a.op===b.ADD)return a.args[0]=q(a.args[0]),a;if(a.op===b.NUM||a.op===b.VAR)return{op:b.MUL,args:[{op:b.NUM,args:["-1"]},a]}}else if(2===a.args.length)return{op:b.SUB,args:[a]};assert(!1,"negate() op="+a.op+" n.args.length="+a.args.length);return{op:b.SUB,args:[a]}}function O(){function a(b){return b===D||b===z||b===N}for(var d=n(),e;a(e=p);){c();var g=n();switch(e){case z:g=
q(g);default:d={op:b.ADD,args:[d,g]}}}return d}function y(){for(var a=O(),b;(b=p)===T;){c();var d=O(),a={op:k[b],args:[a,d]}}return a}var w=0,D=43,S=94,G=261,J=264,K=265,M=47,T=61,u=256,L=263,C=123,R=91,E=40,A=42,Q=48,N=258,B=125,V=93,U=41,I=262,F=259,v=257,z=45,H=260,t=97,t=97,m={ADD:"+",SUB:"-",MUL:"times",DIV:"div",FRAC:"frac",EQL:"=",ATAN2:"atan2",SQRT:"sqrt",PM:"pm",SIN:"sin",COS:"cos",TAN:"tan",SEC:"sec",COT:"cot",CSC:"csc",LN:"ln",VAR:"var",CST:"cst",COMMA:",",POW:"^",ABS:"abs",PAREN:"()",
HIGHLIGHT:"hi"},k=[],p=w,P=w;k[u]=m.FRAC;k[v]=m.SQRT;k[D]=m.ADD;k[z]=m.SUB;k[N]=m.PM;k[S]=m.POW;k[A]=m.MUL;k[M]=m.FRAC;k[F]=m.SIN;k[G]=m.COS;k[H]=m.TAN;k[I]=m.SEC;k[J]=m.COT;k[K]=m.CSC;k[L]=m.LN;k[T]=m.EQL;var s=function(a){var b=0,c="",d=[];d["\\times"]=A;d["\\div"]=M;d["\\dfrac"]=u;d["\\frac"]=u;d["\\sqrt"]=v;d["\\pm"]=N;d["\\sin"]=F;d["\\cos"]=G;d["\\tan"]=H;d["\\sec"]=I;d["\\cot"]=J;d["\\csc"]=K;d["\\ln"]=L;return{start:function(){var e;for(c="";b<a.length;)switch(e=a.charCodeAt(b++)){case 32:case 9:case 10:case 13:continue;
case 92:c+=String.fromCharCode(e);for(e=a.charCodeAt(b++);97<=e&&122>=e;)c+=String.fromCharCode(e),e=a.charCodeAt(b++);b--;e=d[c];void 0===e&&(e=t);return e;case 40:case 41:case 42:case 43:case 44:case 45:case 47:case 61:case 91:case 93:case 94:case 123:case 125:return c+=String.fromCharCode(e),e;default:if(65<=e&&90>=e)return c+=String.fromCharCode(e),65;if(97<=e&&122>=e)return c+=String.fromCharCode(e),t;if(48<=e&&57>=e){for(;48<=e&&57>=e||46===e;)c+=String.fromCharCode(e),e=a.charCodeAt(b++);b--;
return Q}assert(!1,"scan.start(): c="+e);return 0}return 0},lexeme:function(){return c}}}(a);return{expr:function(){p=s.start();return y()}}};TEST&&l();return b}();
