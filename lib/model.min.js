var assert=function(){return DEBUG?function(){}:function(b,h){void 0===h&&(h="failed!");if(!b)try{throw Error("assert: "+h);}catch(a){throw a+"\n"+a.stack;}}}();var global=this,trace=function(){return DEBUG?function(b){if(global.console&&global.console.log)console.log(b);else if(global.print)print(b);else throw"No trace function defined!";}:function(){}}();var Ast=function(){function b(){}function h(a){void 0===a&&(a=this);return a.op&&a.args}var a=["unused"],d={};b.clearPool=function(){a=["unused"];d={}};b.prototype.create=function(a,b){var g=Object.create(this);"string"===typeof a?(g.op=a,g.args=b instanceof Array?b:[]):null!==a&&"object"===typeof a&&Object.keys(a).forEach(function(b,p){g[b]=a[b]});return g};b.prototype.arg=function(a){if(!h(this))throw"Malformed node";this.args.push(a);return this};b.prototype.argN=function(a,b){if(!h(this))throw"Malformed node";
if(void 0===b)return this.args[a];this.args[a]=b;return this};b.prototype.args=function(a){if(!h(this))throw"Malformed node";if(void 0===a)return this.args;this.args=a;return this};b.prototype.isNode=h;b.intern=b.prototype.intern=function q(g){this instanceof b&&void 0===g&&h(this)&&(g=this);"number"===typeof g?g={op:"num",args:[g]}:"string"===typeof g&&(g={op:"str",args:[g]});assert("object"===typeof g,"node not an object");for(var r=g.op,p=g.args.length,e="",f=[],c=0;c<p;c++)e="num"===g.op||"str"===
g.op?e+(f[c]=g.args[c]):e+(f[c]=q(g.args[c]));g=r+p+e;p=d[g];void 0===p&&(a.push({op:r,args:f}),p=a.length-1,d[g]=p);return p};b.prototype.node=function(b){b=JSON.parse(JSON.stringify(a[b]));var g=this.create(b);switch(b.op){case "num":case "str":b=b.args[0];break;default:for(var d=0;d<b.args.length;d++)b.args[d]=g(b.args[d])}return b};b.dumpAll=b.prototype.dumpAll=function(){var d="";a.forEach(function(a,r){d+="\n"+r+": "+b.dump(a)});return d};b.dump=b.prototype.dump=function g(a){if("string"===
typeof a)var b='"'+a+'"';else if("number"===typeof a)b=a;else{for(var b='{ op: "'+a.op+'", args: [ ',e=0;e<a.args.length;e++)0<e&&(b+=" , "),b+=g(a.args[e]);b+=" ] }"}return b};return b}();var Model=function(){function b(){}b.fn={};var h=b.prototype=new Ast;b.create=h.create=function(a){assert(a,"Model.create() called with invalid argument: "+a);if(!(this instanceof b))return(new b).create(a);var d=Object.create(this);a="string"===typeof a?q(a).expr():JSON.parse(JSON.stringify(a));Object.keys(b.fn).forEach(function(a,d){h.hasOwnProperty(a)||(h[a]=function(){var d=b.fn[a];if(1<arguments.length&&arguments[1]instanceof b)return d.apply(this,arguments);for(var e=[this],g=0;g<arguments.length;g++)e.push(arguments[g]);
return d.apply(this,e)})});Object.keys(a).forEach(function(b,e){d[b]=a[b]});return d};b.fromLaTex=h.fromLaTex=function(a){assert("string"===typeof a,"Model.prototype.fromLaTex");return this?this.create(a):b.create(a)};h.toLaTex=function(a){return B(a)};var a={ADD:"+",SUB:"-",MUL:"times",DIV:"div",FRAC:"frac",EQL:"=",ATAN2:"atan2",SQRT:"sqrt",PM:"pm",SIN:"sin",COS:"cos",TAN:"tan",SEC:"sec",COT:"cot",CSC:"csc",LN:"ln",VAR:"var",NUM:"num",CST:"cst",COMMA:",",POW:"^",ABS:"abs",PAREN:"()",HIGHLIGHT:"hi",
INTERVAL:"interval"};Object.keys(a).forEach(function(d,h){b[d]=a[d]});var d={};d[a.ADD]="+";d[a.SUB]="-";d[a.MUL]="\\times";d[a.DIV]="\\div";d[a.FRAC]="\\frac";d[a.EQL]="=";d[a.ATAN2]="\\atan2";d[a.POW]="^";d[a.PM]="\\pm";d[a.SIN]="\\sin";d[a.COS]="\\cos";d[a.TAN]="\\tan";d[a.SEC]="\\sec";d[a.COT]="\\cot";d[a.CSC]="\\csc";d[a.LN]="\\ln";d[a.COMMA]=",";var B=function r(b){var e="";if("string"===typeof b)e=b;else if("number"===typeof b)e=b;else if("object"===typeof b){for(var f=[],c=0;c<b.args.length;c++)f[c]=
r(b.args[c]);switch(b.op){case a.VAR:case a.CST:case a.NUM:e=b.args[0];break;case a.SUB:e=1===b.args.length?d[b.op]+" "+f[0]:f[0]+" "+d[b.op]+" "+f[1];break;case a.DIV:case a.PM:case a.EQL:e=f[0]+" "+d[b.op]+" "+f[1];break;case a.POW:var c=b.args[0],h=b.args[1];if(c.args&&2===c.args.length||h.args&&2===h.args.length)if(c.op===a.ADD||c.op===a.SUB||c.op===a.MUL||c.op===a.DIV||c.op===a.SQRT)f[0]=" ("+f[0]+") ";e="{"+f[0]+"^{"+f[1]+"}}";break;case a.SIN:case a.COS:case a.TAN:case a.SEC:case a.COT:case a.CSC:case a.LN:e=
"{"+d[b.op]+"{"+f[0]+"}}";break;case a.FRAC:e="\\dfrac{"+f[0]+"}{"+f[1]+"}";break;case a.SQRT:switch(f.length){case 1:e="\\sqrt{"+f[0]+"}";break;case 2:e="\\sqrt["+f[0]+"]{"+f[1]+"}"}break;case a.MUL:var s,e="";b.args.forEach(function(c,h){if(c.args&&2<=c.args.length){if(c.op===a.ADD||c.op===a.SUB)f[h]="("+f[h]+")";0!==h&&"number"===typeof c&&(e+=d[b.op]+" ")}else c.op===a.PAREN||c.op===a.VAR||c.op===a.CST||"number"===typeof s&&"number"!==typeof c||0!==h&&(e+=" "+d[b.op]+" ");e+=f[h];s=c});break;
case a.ADD:case a.COMMA:f.forEach(function(a,c){e=0===c?a:e+" "+d[b.op]+" "+a});break;default:assert(!1,"unimplemented eval operator")}}else assert(!1,"invalid expression type");return e},q=function(a){function d(){n=R;R=x;n===x&&(n=t.start())}function e(a){var b=n;b!==a&&(assert(!1,"Expecting "+a+" found "+b),trace("error: syntax error"));d()}function f(){e(C);var a=y();e(B);return a}function c(){var a;switch(n){case D:d();a=c();break;case z:d();a=c();a={op:b.SUB,args:[a]};break;default:var m;switch(a=
n){case 65:case u:m={op:"var",args:[t.lexeme()]};d();break;case 97:m={op:"var",args:[t.lexeme()]};d();break;case S:m={op:"num",args:[t.lexeme()]};d();break;case T:e(a);m=y();e(tk2=n===U?U:E);2===m.args.length||a!==F&&tk2!==E||assert(!1,"Square brackets can only be used to denote intervals.");m.lbrk=a;m.rbrk=tk2;break;case C:m=f();break;case v:d();m={op:k[v],args:[f(),f()]};break;case w:d();switch(n){case F:a=k[w];e(F);m=y();e(E);m={op:a,args:[m,f()]};break;case C:m={op:k[w],args:[f()]};break;default:assert(!1)}break;
case G:case H:case I:case J:case K:case L:case M:d();m={op:k[a],args:[f()]};break;default:m=void 0}a=m}return a}function h(){for(var a=c(),b;(b=n)===V;){d();var e=c();1!==e&&(a=0===e?1:{op:k[b],args:[a,e]})}return a}function s(){function a(b){return b===A||b===N}for(var b=h(),e;(e=n)===u||e===T;){var c=h();1!==c&&(b=1===b?c:{op:l.MUL,args:[b,c]})}for(;a(e=n);)d(),c=h(),1!==c&&(b=e===A&&1===b?c:{op:k[e],args:[b,c]});return b}function q(a){if("number"===typeof a)return-a;if(1===a.args.length){if(a.op===
b.SUB)return a.args[0];if(a.op===b.ADD)return a.args[0]=q(a.args[0]),a;if(a.op===b.NUM||a.op===b.VAR)return{op:b.MUL,args:[{op:b.NUM,args:["-1"]},a]}}else if(2===a.args.length)return{op:b.SUB,args:[a]};assert(!1,"negate() op="+a.op+" n.args.length="+a.args.length);return{op:b.SUB,args:[a]}}function Q(){function a(b){return b===D||b===z||b===O}for(var e=s(),c;a(c=n);){d();var f=s();switch(c){case z:f=q(f);default:e={op:b.ADD,args:[e,f]}}}return e}function W(){for(var a=Q(),b;(b=n)===X;){d();var e=
Q(),a={op:k[b],args:[a,e]}}return a}function y(){for(var a=W(),b=[a];n===P;)d(),b.push(W());return 1<b.length?{op:k[P],args:b}:a}var x=0,D=43,V=94,H=261,K=264,L=265,N=47,X=61,v=256,M=263,C=123,F=91,T=40,A=42,S=48,O=258,B=125,E=93,U=41,J=262,G=259,w=257,z=45,I=260,u=97,P=44,l={ADD:"+",SUB:"-",MUL:"times",DIV:"div",FRAC:"frac",EQL:"=",ATAN2:"atan2",SQRT:"sqrt",PM:"pm",SIN:"sin",COS:"cos",TAN:"tan",SEC:"sec",COT:"cot",CSC:"csc",LN:"ln",VAR:"var",CST:"cst",COMMA:",",POW:"^",ABS:"abs",PAREN:"()",HIGHLIGHT:"hi"},
k=[],n=x,R=x;k[v]=l.FRAC;k[w]=l.SQRT;k[D]=l.ADD;k[z]=l.SUB;k[O]=l.PM;k[V]=l.POW;k[A]=l.MUL;k[N]=l.FRAC;k[G]=l.SIN;k[H]=l.COS;k[I]=l.TAN;k[J]=l.SEC;k[K]=l.COT;k[L]=l.CSC;k[M]=l.LN;k[X]=l.EQL;k[P]=l.COMMA;var t=function(a){var b=0,d="",e=[];e["\\times"]=A;e["\\div"]=N;e["\\dfrac"]=v;e["\\frac"]=v;e["\\sqrt"]=w;e["\\pm"]=O;e["\\sin"]=G;e["\\cos"]=H;e["\\tan"]=I;e["\\sec"]=J;e["\\cot"]=K;e["\\csc"]=L;e["\\ln"]=M;return{start:function(){var c;for(d="";b<a.length;)switch(c=a.charCodeAt(b++)){case 32:case 9:case 10:case 13:continue;
case 92:d+=String.fromCharCode(c);for(c=a.charCodeAt(b++);97<=c&&122>=c;)d+=String.fromCharCode(c),c=a.charCodeAt(b++);b--;c=e[d];void 0===c&&(c=u);return c;case 40:case 41:case 42:case 43:case 44:case 45:case 47:case 61:case 91:case 93:case 94:case 123:case 125:return d+=String.fromCharCode(c),c;default:if(65<=c&&90>=c)return d+=String.fromCharCode(c),u;if(97<=c&&122>=c){a:for(;97<=c&&122>=c;){c=String.fromCharCode(c);switch(d){case "":d+=c;break;case "k":case "c":case "m":case "n":switch(c){case "g":case "m":case "s":d+=
c;break;default:break a}break;default:break a}c=a.charCodeAt(b++)}b--;return u}if(46===c||48<=c&&57>=c){for(;48<=c&&57>=c||46===c;)d+=String.fromCharCode(c),c=a.charCodeAt(b++);b--;return S}assert(!1,"scan.start(): c="+c);return 0}return 0},lexeme:function(){return d}}}(a);return{expr:function(){n=t.start();return y()}}};return b}();
