var assert=function(){return DEBUG?function(b,k){void 0===k&&(k="failed!");if(!b)try{throw Error("assert: "+k);}catch(a){throw a+"\n"+a.stack;}}:function(){}}();var global=this,trace=function(){return DEBUG?function(b){if(global.console&&global.console.log)console.log(b);else if(global.print)print(b);else throw"No trace function defined!";}:function(){}}();var Ast=function(){function b(){}function k(b){void 0===b&&(b=this);return b.op&&b.args}var a=["unused"],c={};b.clearPool=function(){a=["unused"];c={}};b.prototype.create=function(b,a){var h=Object.create(this);"string"===typeof b?(h.op=b,h.args=a instanceof Array?a:[]):null!==b&&"object"===typeof b&&Object.keys(b).forEach(function(a,n){h[a]=b[a]});return h};b.prototype.arg=function(b){if(!k(this))throw"Malformed node";this.args.push(b);return this};b.prototype.argN=function(b,a){if(!k(this))throw"Malformed node";
if(void 0===a)return this.args[b];this.args[b]=a;return this};b.prototype.args=function(b){if(!k(this))throw"Malformed node";if(void 0===b)return this.args;this.args=b;return this};b.prototype.isNode=k;b.intern=b.prototype.intern=function q(h){this instanceof b&&void 0===h&&k(this)&&(h=this);"number"===typeof h?h={op:"num",args:[h]}:"string"===typeof h&&(h={op:"str",args:[h]});assert("object"===typeof h,"node not an object");for(var r=h.op,n=h.args.length,e="",f=[],d=0;d<n;d++)e="num"===h.op||"str"===
h.op?e+(f[d]=h.args[d]):e+(f[d]=q(h.args[d]));h=r+n+e;n=c[h];void 0===n&&(a.push({op:r,args:f}),n=a.length-1,c[h]=n);return n};b.prototype.node=function(b){b=JSON.parse(JSON.stringify(a[b]));var h=this.create(b);switch(b.op){case "num":case "str":b=b.args[0];break;default:for(var c=0;c<b.args.length;c++)b.args[c]=h(b.args[c])}return b};b.dumpAll=b.prototype.dumpAll=function(){var c="";a.forEach(function(a,r){c+="\n"+r+": "+b.dump(a)});return c};b.dump=b.prototype.dump=function h(b){if("string"===
typeof b)var a='"'+b+'"';else if("number"===typeof b)a=b;else{for(var a='{ op: "'+b.op+'", args: [ ',e=0;e<b.args.length;e++)0<e&&(a+=" , "),a+=h(b.args[e]);a+=" ] }"}return a};return b}();var Model=function(){function b(){}b.fn={};var k=b.prototype=new Ast;b.create=k.create=function(a){assert(a,"Model.create() called with invalid argument: "+a);if(a instanceof b)return a;if(!(this instanceof b))return(new b).create(a);var c=Object.create(this);a="string"===typeof a?q(a).expr():JSON.parse(JSON.stringify(a));Object.keys(b.fn).forEach(function(a,c){k.hasOwnProperty(a)||(k[a]=function(){var c=b.fn[a];if(1<arguments.length&&arguments[1]instanceof b)return c.apply(this,arguments);for(var e=
[this],h=0;h<arguments.length;h++)e.push(arguments[h]);return c.apply(this,e)})});Object.keys(a).forEach(function(b,e){c[b]=a[b]});return c};b.fromLaTex=k.fromLaTex=function(a){assert("string"===typeof a,"Model.prototype.fromLaTex");return this?this.create(a):b.create(a)};k.toLaTex=function(b){return A(b)};var a={ADD:"+",SUB:"-",MUL:"times",DIV:"div",FRAC:"frac",EQL:"=",ATAN2:"atan2",SQRT:"sqrt",PM:"pm",SIN:"sin",COS:"cos",TAN:"tan",SEC:"sec",COT:"cot",CSC:"csc",LN:"ln",VAR:"var",NUM:"num",CST:"cst",
COMMA:",",POW:"^",ABS:"abs",PAREN:"()",HIGHLIGHT:"hi",INTERVAL:"interval"};Object.keys(a).forEach(function(c,k){b[c]=a[c]});var c={};c[a.ADD]="+";c[a.SUB]="-";c[a.MUL]="\\times";c[a.DIV]="\\div";c[a.FRAC]="\\frac";c[a.EQL]="=";c[a.ATAN2]="\\atan2";c[a.POW]="^";c[a.PM]="\\pm";c[a.SIN]="\\sin";c[a.COS]="\\cos";c[a.TAN]="\\tan";c[a.SEC]="\\sec";c[a.COT]="\\cot";c[a.CSC]="\\csc";c[a.LN]="\\ln";c[a.COMMA]=",";var A=function r(b){var e="";if("string"===typeof b)e=b;else if("number"===typeof b)e=b;else if("object"===
typeof b){for(var f=[],d=0;d<b.args.length;d++)f[d]=r(b.args[d]);switch(b.op){case a.VAR:case a.CST:case a.NUM:e=b.args[0];break;case a.SUB:e=1===b.args.length?c[b.op]+" "+f[0]:f[0]+" "+c[b.op]+" "+f[1];break;case a.DIV:case a.PM:case a.EQL:e=f[0]+" "+c[b.op]+" "+f[1];break;case a.POW:var d=b.args[0],k=b.args[1];if(d.args&&2===d.args.length||k.args&&2===k.args.length)if(d.op===a.ADD||d.op===a.SUB||d.op===a.MUL||d.op===a.DIV||d.op===a.SQRT)f[0]=" ("+f[0]+") ";e="{"+f[0]+"^{"+f[1]+"}}";break;case a.SIN:case a.COS:case a.TAN:case a.SEC:case a.COT:case a.CSC:case a.LN:e=
"{"+c[b.op]+"{"+f[0]+"}}";break;case a.FRAC:e="\\dfrac{"+f[0]+"}{"+f[1]+"}";break;case a.SQRT:switch(f.length){case 1:e="\\sqrt{"+f[0]+"}";break;case 2:e="\\sqrt["+f[0]+"]{"+f[1]+"}"}break;case a.MUL:var t,e="";b.args.forEach(function(d,k){if(d.args&&2<=d.args.length){if(d.op===a.ADD||d.op===a.SUB)f[k]="("+f[k]+")";0!==k&&"number"===typeof d&&(e+=c[b.op]+" ")}else d.op===a.PAREN||d.op===a.VAR||d.op===a.CST||"number"===typeof t&&"number"!==typeof d||0!==k&&(e+=" "+c[b.op]+" ");e+=f[k];t=d});break;
case a.ADD:case a.COMMA:f.forEach(function(a,d){e=0===d?a:e+" "+c[b.op]+" "+a});break;default:assert(!1,"unimplemented eval operator")}}else assert(!1,"invalid expression type");return e},q=function(a){function c(){m=Q;Q=w;m===w&&(m=p.start())}function e(b){var a=m;a!==b&&(assert(!1,"Expecting "+b+" found "+a),trace("error: syntax error"));c()}function f(){e(B);var b=x();e(A);return b}function d(){var a;switch(m){case C:c();a=d();break;case y:c();a=d();a={op:b.SUB,args:[a]};break;default:var g;switch(a=
m){case 65:case u:g={op:"var",args:[p.lexeme()]};c();break;case 97:g={op:"var",args:[p.lexeme()]};c();break;case R:g={op:"num",args:[p.lexeme()]};c();break;case S:e(a);g=x();e(tk2=m===T?T:D);2===g.args.length||a!==E&&tk2!==D||assert(!1,"Square brackets can only be used to denote intervals.");g.lbrk=a;g.rbrk=tk2;break;case B:g=f();break;case s:c();a=f();g=f();g={op:b.MUL,args:[a,{op:b.POW,args:[g,{op:b.NUM,args:["-1"]}]}]};break;case F:c();switch(m){case E:e(E);a=x();e(D);g=f();g={op:b.POW,args:[g,
a,{op:b.NUM,args:["-1"]}]};break;case B:g=f();g=g.op===b.POW?{op:b.POW,args:[g.args[0],{op:b.MUL,args:[g.args[1],{op:b.POW,args:[{op:b.NUM,args:["2"]},{op:b.NUM,args:["-1"]}]}]}]}:{op:b.POW,args:[g,{op:b.NUM,args:["2"]},{op:b.NUM,args:["-1"]}]};break;default:assert(!1)}break;case G:case H:case I:case J:case K:case L:case M:c();g={op:l[a],args:[f()]};break;default:g=void 0}a=g}return a}function k(){for(var a=[d()];m===U;)c(),a.push(d());return 1<a.length?{op:b.POW,args:a}:a[0]}function t(){for(var a,
g,e=[k()];(a=m)===u||a===S||a===z||a===v||a===s;)a===z||a===v||a===s?(op=l[a],c()):op=b.MUL,g=k(),a===v&&(g={op:b.POW,args:[g,{op:b.NUM,args:["-1"]}]}),e.push(g);return 1<e.length?{op:b.MUL,args:e}:e[0]}function q(a){if("number"===typeof a)return-a;if(1===a.args.length){if(a.op===b.SUB)return a.args[0];if(a.op===b.ADD)return a.args[0]=q(a.args[0]),a;if(a.op===b.NUM||a.op===b.VAR)return{op:b.MUL,args:[{op:b.NUM,args:["-1"]},a]}}else if(2===a.args.length)return{op:b.SUB,args:[a]};assert(!1,"negate() op="+
a.op+" n.args.length="+a.args.length);return{op:b.SUB,args:[a]}}function P(){function a(b){return b===C||b===y||b===N}for(var g=t(),e;a(e=m);){c();var d=t();switch(e){case y:d=q(d);default:g={op:b.ADD,args:[g,d]}}}return g}function V(){for(var a=P(),b;(b=m)===W;){c();var e=P(),a={op:l[b],args:[a,e]}}return a}function x(){for(var a=V(),b=[a];m===O;)c(),b.push(V());return 1<b.length?{op:l[O],args:b}:a}var w=0,C=43,U=94,H=261,K=264,L=265,v=47,W=61,s=256,M=263,B=123,E=91,S=40,z=42,R=48,N=258,A=125,D=
93,T=41,J=262,G=259,F=257,y=45,I=260,u=97,O=44,l=[],m=w,Q=w;l[s]="frac";l[F]="sqrt";l[C]="+";l[y]="-";l[N]="pm";l[U]="^";l[z]="times";l[v]="frac";l[G]="sin";l[H]="cos";l[I]="tan";l[J]="sec";l[K]="cot";l[L]="csc";l[M]="ln";l[W]="=";l[O]=",";var p=function(a){var b=0,c="",e=[];e["\\times"]=z;e["\\div"]=v;e["\\dfrac"]=s;e["\\frac"]=s;e["\\sqrt"]=F;e["\\pm"]=N;e["\\sin"]=G;e["\\cos"]=H;e["\\tan"]=I;e["\\sec"]=J;e["\\cot"]=K;e["\\csc"]=L;e["\\ln"]=M;return{start:function(){var d;for(c="";b<a.length;)switch(d=
a.charCodeAt(b++)){case 32:case 9:case 10:case 13:continue;case 92:c+=String.fromCharCode(d);for(d=a.charCodeAt(b++);97<=d&&122>=d;)c+=String.fromCharCode(d),d=a.charCodeAt(b++);b--;d=e[c];void 0===d&&(d=u);return d;case 40:case 41:case 42:case 43:case 44:case 45:case 47:case 61:case 91:case 93:case 94:case 123:case 125:return c+=String.fromCharCode(d),d;default:if(65<=d&&90>=d)return c+=String.fromCharCode(d),u;if(97<=d&&122>=d){a:for(;97<=d&&122>=d;){d=String.fromCharCode(d);switch(c){case "":c+=
d;break;case "k":case "c":case "m":case "n":switch(d){case "g":case "m":case "s":c+=d;break;default:break a}break;default:break a}d=a.charCodeAt(b++)}b--;return u}if(46===d||48<=d&&57>=d){for(;48<=d&&57>=d||46===d;)c+=String.fromCharCode(d),d=a.charCodeAt(b++);b--;return R}assert(!1,"scan.start(): c="+d);return 0}return 0},lexeme:function(){return c},pos:function(){return b}}}(a);return{expr:function(){m=p.start();var a=x();assert(!m,"Unexpected input at character position: "+p.pos()+" lexeme: "+
p.lexeme());return a}}};return b}();
